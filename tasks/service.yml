---
- name: Template service definition
  template:
    src: 'service.yml.j2'
    dest: '{{ winsw_service_definition }}'
    user: 'jenkins'
  register: service_file

- name: Check Jenkins agent service status
  win_command: '{{ winsw_service_wrapper_path }} status'
  register: service_status
  ignore_errors: true

- name: Stop the Jenkins agent service
  win_command: '{{ winsw_service_wrapper_path }} stopwait'
  register: service_install
  when: >
    (service_status.stdout|trim) != "NonExistent"
    and service_file.changed

- name: Uninstall the Jenkins agent service
  win_command: '{{ winsw_service_wrapper_path }} uninstall'
  register: service_install
  when: >
    (service_status.stdout|trim) != "NonExistent"
    and service_file.changed

- name: Install the Jenkins agent service
  win_command: '{{ winsw_service_wrapper_path }} install'
  when: >
    (service_status.stdout|trim) == "NonExistent"
    or service_install.changed

- name: (Re)Start the Jenkins agent service
  win_command: '{{ winsw_service_wrapper_path }} restart'
